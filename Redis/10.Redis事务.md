> 事务的本质是一组操作一次完成
>
> `redis`中的单条事务保证原子性，但事务不保证原子性
>
> `redis`事务执行流程：开启事务，命令入队，执行事务

#### 开启事务命令

```
multi
```

#### 命令入队

```
set k1 v1
set k2 v2
```

> 命令中存在语法错误会导致事务直接失败
>
> 运行时存在错误事务不会失败，后面的命令都会执行。(如对字符串+1)

#### 执行命令

```
exec
```

#### 放弃事务

```
discard
```

> 在执行命令之前执行



# 乐观锁

悲观锁：认为什么都会出问题，做什么事都会加锁，性能很低

乐观锁：认为什么时候都不会出问题，所以不会加锁。更新数据的时候去判断此数据是否已经被修改。比如通过version字段的值

#### 通过`watch`实现乐观锁

```
watch key1 key2
```

#### 示例

```
watch money
multi
decrby money 20
incrby money 20
exec
```

> 此时正常运行
>
> 但如果事务中别的线程修改了该值，此时执行会失败

#### 通过`unwatch`放弃监视

```
unwatch key1 key2
```

> 当监视时出现事务执行失败，需要放弃监视，重新获取监视再操作